{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block content %}
<body class="ven-light-mode">

<!-- âœ… TOPBAR -->
<div class="ven-topbar">
  <img src="{% static 'img/logo.jpg' %}" alt="Logo" class="logo-img-small">
  <div class="ven-topbar-center">
    <span class="ven-welcome-message">Bienvenido, {{ user.username }}</span>
  </div>
  <div style="display: flex; gap: 10px;">
    <button id="modeToggle" class="ven-mode-toggle" onclick="toggleMode()">ðŸŒ™ Oscuro</button>
    <button onclick="toggleCarrito()" class="ven-mode-toggle">ðŸ›’ Carrito</button>
    <button class="ven-logout-button" onclick="confirmLogout()">Cerrar sesiÃ³n</button>
  </div>
</div>

<!-- âœ… TOTAL GENERAL centrado -->
<div style="text-align: center; margin: 25px 0; font-size: 32px; font-weight: bold; color: #2E8B57;">
  Total general: <span id="totalHeader">$0</span>
</div>

<!-- âœ… INVENTARIO -->
<div class="ven-main-content">
  <div class="ven-inventory-header">
    <span>Productos</span>
    <input type="text" placeholder="Buscar producto..." id="busqueda" onkeyup="filtrarProductos()">
  </div>
  <div class="ven-inventory-box">
    <table class="ven-inventory-table">
      <thead>
        <tr>
          <th>Producto</th>
          <th>Nombre</th>
          <th>Precio</th>
          <th>Disponibles</th>
          <th>Agregar</th>
          <th>Cantidades</th>
          <th>Eliminar</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody>
        {% for producto in productos %}
        <tr class="product-row" data-name="{{ producto.nombre|lower }}">
          <td>
            <img src="{{ producto.imagen.url }}" alt="{{ producto.nombre }}" class="ven-product-image"
                 data-img="{{ producto.imagen.url }}" data-name="{{ producto.nombre }}"
                 data-price="{{ producto.precio_oferta|default:producto.precio }}">
          </td>
          <td>{{ producto.nombre }}</td>
          <td class="price-cell" data-price="{{ producto.precio_oferta|default:producto.precio }}">
            {% if producto.precio_oferta %}
              <span style="text-decoration: line-through; color: red;">
                ${{ producto.precio|floatformat:0|intcomma }}
              </span><br>
              <span style="color: green; font-weight: bold;">
                ${{ producto.precio_oferta|floatformat:0|intcomma }}
              </span>
            {% else %}
              ${{ producto.precio|floatformat:0|intcomma }}
            {% endif %}
          </td>
          <td id="prod{{ producto.id }}">{{ producto.cantidad }}</td>
          <td>
            <button class="ven-add-button"
              onclick="addProduct({{ producto.id }}, '{{ producto.nombre }}',
                {{ producto.precio_oferta|default:producto.precio }},
                '{{ producto.imagen.url }}')">+</button>
          </td>
          <td><span id="prov{{ producto.id }}">0</span></td>
          <td>
            <button class="ven-remove-button"
              onclick="removeProduct({{ producto.id }}, {{ producto.precio_oferta|default:producto.precio }})">-</button>
          </td>
          <td class="ven-row-total">$0</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <div style="margin-top: 25px; font-size: 28px; font-weight: bold; text-align: right;">
      Total general: <span id="totalSum">$0</span>
    </div>
  </div>
</div>

<!-- âœ… MODAL CARRITO -->
<div id="carritoModal" class="ven-modal">
  <div class="ven-modal-content">
    <span class="ven-modal-close" onclick="toggleCarrito()">&times;</span>
    <h2>Carrito de Compras</h2>
    <table class="ven-carrito-table">
      <thead>
        <tr><th>Producto</th><th>Nombre</th><th>Cantidad</th><th>Total</th></tr>
      </thead>
      <tbody id="carritoItems"></tbody>
    </table>
    <div style="margin-top: 20px; font-size: 18px; text-align: right;">Total: <span id="carritoTotal">$0</span></div>
    <div id="codigoGenerado" style="margin-top: 20px; font-size: 18px; color: green; font-weight: bold;"></div>
    <div style="margin-top: 20px; text-align: center;">
      <button onclick="mostrarConfirmacion()" class="ven-mode-toggle" style="background-color: green; color: white;">Agregar productos al carrito</button>
    </div>
  </div>
</div>

<!-- âœ… MODAL CONFIRMACIÃ“N -->
<div id="confirmModal" class="ven-modal">
  <div class="ven-modal-content">
    <span class="ven-modal-close" onclick="document.getElementById('confirmModal').style.display='none'">&times;</span>
    <h2>Â¿EstÃ¡s seguro de agregar los productos al carrito?</h2>
    <div style="margin-top: 20px; display: flex; justify-content: center; gap: 10px;">
      <button onclick="confirmarCompra()" class="ven-mode-toggle" style="background-color: green; color: white;">SÃ­</button>
      <button onclick="document.getElementById('confirmModal').style.display='none'" class="ven-mode-toggle">No</button>
    </div>
  </div>
</div>

<!-- âœ… MODAL IMAGEN -->
<div id="myModal" class="ven-modal">
  <div class="ven-modal-content">
    <span class="ven-modal-close" onclick="document.getElementById('myModal').style.display='none'">&times;</span>
    <img id="modalImg" class="ven-modal-img" src="" alt="Producto">
    <h3 id="modalTitle"></h3>
    <p id="modalPrice"></p>
  </div>
</div>

<!-- âœ… SCRIPT -->
<script>
  let carrito = {};
  const csrfToken = "{{ csrf_token }}";

  function addProduct(id, nombre, precio, img) {
    let cantidadSpan = document.getElementById('prov' + id);
    let cantidad = parseInt(cantidadSpan.textContent) + 1;
    cantidadSpan.textContent = cantidad;

    carrito[id] = { id: id, nombre: nombre, cantidad: cantidad, precio: precio, img: img };
    actualizarSubtotal(id, precio);
    actualizarCarrito();
  }

  function removeProduct(id, precio) {
    let cantidadSpan = document.getElementById('prov' + id);
    let cantidad = parseInt(cantidadSpan.textContent);
    if (cantidad > 0) {
      cantidad -= 1;
      cantidadSpan.textContent = cantidad;

      if (cantidad === 0) {
        delete carrito[id];
      } else {
        carrito[id].cantidad = cantidad;
      }

      actualizarSubtotal(id, precio);
      actualizarCarrito();
    }
  }

  function actualizarSubtotal(id, precio) {
    let cantidad = parseInt(document.getElementById('prov' + id).textContent);
    let subtotal = cantidad * precio;

    let fila = document.getElementById('prov' + id).closest('tr');
    fila.querySelector('.ven-row-total').textContent = '$' + subtotal.toLocaleString('es-CL');

    actualizarTotalGeneral();
  }

  function actualizarTotalGeneral() {
    let total = 0;
    document.querySelectorAll('.ven-row-total').forEach(cell => {
      let valor = parseInt(cell.textContent.replace('$','').replace(/\./g,'')); 
      total += isNaN(valor) ? 0 : valor;
    });
    let totalFormatted = '$' + total.toLocaleString('es-CL');
    document.getElementById('totalSum').textContent = totalFormatted;
    document.getElementById('totalHeader').textContent = totalFormatted;
    document.getElementById('carritoTotal').textContent = totalFormatted;
  }

  function actualizarCarrito() {
    const tbody = document.getElementById('carritoItems');
    tbody.innerHTML = '';

    Object.entries(carrito).forEach(([id, item]) => {
      if (item.cantidad > 0) {
        const total = item.cantidad * item.precio;
        tbody.innerHTML += `
          <tr>
            <td><img src="${item.img}" alt="${item.nombre}" style="width:50px; height:50px;"></td>
            <td>${item.nombre}</td>
            <td>${item.cantidad}</td>
            <td>$${total.toLocaleString('es-CL')}</td>
          </tr>
        `;
      }
    });
  }

  function mostrarConfirmacion() {
    document.getElementById('confirmModal').style.display = 'block';
  }

  function confirmarCompra() {
    fetch("{% url 'guardar_carrito' %}", {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
      },
      body: JSON.stringify({ carrito: Object.values(carrito) })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        window.location.href = `/boleta/${data.codigo}/`;
      } else {
        alert('Error al guardar carrito');
      }
    });
  }

  function filtrarProductos() {
    const input = document.getElementById('busqueda').value.toLowerCase();
    const filas = document.querySelectorAll('.product-row');
    filas.forEach(fila => {
      const nombre = fila.dataset.name.toLowerCase();
      fila.style.display = nombre.includes(input) ? '' : 'none';
    });
  }

  function toggleMode() {
    const isDark = document.body.classList.contains('ven-dark-mode');
    document.body.classList.toggle('ven-dark-mode', !isDark);
    document.body.classList.toggle('ven-light-mode', isDark);
    document.getElementById('modeToggle').innerText = isDark ? 'ðŸŒ™ Oscuro' : 'â˜€ Claro';
    localStorage.setItem('theme', isDark ? 'light' : 'dark');
  }

  function toggleCarrito() {
    const modal = document.getElementById('carritoModal');
    modal.style.display = modal.style.display === 'block' ? 'none' : 'block';
  }

  function confirmLogout() {
    if (confirm("Â¿EstÃ¡s seguro que deseas cerrar sesiÃ³n?")) {
      window.location.href = "{% url 'cerrar_sesion' %}";
    }
  }
</script>
</body>
{% endblock %}
